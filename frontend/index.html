<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通讯录</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .contact-list { list-style: none; padding: 0; }
        .contact-item { background: #f4f4f4; margin-bottom: 10px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .contact-info { flex-grow: 1; }
        .contact-item.favorite { background: #fffacd; } /* 淡黄色表示收藏 */
        .favorite-btn { background: none; border: none; cursor: pointer; font-size: 1.5em; }
        .favorite-btn.is-favorite { color: gold; }
        .header-section { text-align: center; margin-bottom: 20px; }
        .button-group { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .contact-detail-line { margin-bottom: 0.2em; }
        .detail-type-label { display: inline-block; width: 7em; text-align: left; margin-right: 0.5em; vertical-align: top; /* 调整宽度以适应最长标签 */ }
        .detail-value-first { display: inline; /* 确保第一个值与标签在同一行 */ }
        .detail-value-subsequent { display: block; margin-left: calc(7em + 0.5em); /* 确保后续值与第一个值对齐 */ }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>通讯录应用</h1>

        <div class="button-group">
            <button id="add-contact-btn">添加新联系人</button>
            <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display: none;">
            <button id="import-btn">导入联系人</button>
            <button id="export-btn">导出联系人</button>
            <button id="toggle-favorite-btn">显示收藏</button>
        </div>
    </div>

    <ul id="contact-list" class="contact-list">
        <!-- 联系人将在这里渲染 -->
    </ul>

    <!-- 联系人编辑/添加模态框 -->
    <div id="contact-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; width: 400px;">
            <h2><span id="modal-title">添加新联系人</span></h2>
            <form id="contact-form">
                <input type="hidden" id="contact-id">
                <label for="contact-name">姓名:</label><br>
                <input type="text" id="contact-name" required><br><br>

                <div id="contact-details-container">
                    <h3>联系方式:</h3>
                    <!-- 联系方式将在这里动态添加 -->
                </div>
                <button type="button" id="add-detail-btn">添加联系方式</button><br><br>

                <button type="submit">保存</button>
                <button type="button" id="close-modal-btn">取消</button>
            </form>
        </div>
    </div>

    <script>
        const contactList = document.getElementById('contact-list');
        const addContactBtn = document.getElementById('add-contact-btn');
        const contactModal = document.getElementById('contact-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const contactForm = document.getElementById('contact-form');
        const contactIdInput = document.getElementById('contact-id');
        const contactNameInput = document.getElementById('contact-name');
        const contactDetailsContainer = document.getElementById('contact-details-container');
        const addDetailBtn = document.getElementById('add-detail-btn');
        const modalTitle = document.getElementById('modal-title');
        const importFileInput = document.getElementById('import-file-input');
        const importBtn = document.getElementById('import-btn');
        const exportBtn = document.getElementById('export-btn');
        const toggleFavoriteBtn = document.getElementById('toggle-favorite-btn');

        let currentEditingContact = null; // 用于存储当前正在编辑的联系人
        let showFavoritesOnly = false; // 控制是否只显示收藏的联系人

        // 后端 API 地址 - 生产环境使用相对路径，开发环境使用完整 URL
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://127.0.0.1:5000' 
            : '/contacts/api'; // 生产环境通过 Nginx 代理（子路径配置）

        async function fetchContacts() {
            try {
                const response = await fetch(`${API_BASE_URL}/contacts`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('获取联系人失败:', error);
                return [];
            }
        }

        async function updateFavoriteStatus(contactId, isFavorite) {
            try {
                const response = await fetch(`${API_BASE_URL}/contacts/${contactId}/favorite`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_favorite: isFavorite }),
                });
                if (!response.ok) {
                    throw new Error('更新收藏状态失败');
                }
                const updatedContact = await response.json();
                console.log('联系人收藏状态更新成功:', updatedContact);
                renderContacts(); // 重新渲染列表以更新 UI
            } catch (error) {
                console.error('更新收藏状态失败:', error);
            }
        }

        async function renderContacts() {
            let contacts = await fetchContacts();
            if (showFavoritesOnly) {
                contacts = contacts.filter(contact => contact.is_favorite);
            }
            contactList.innerHTML = ''; // 清空现有列表
            contacts.forEach(contact => {
                const listItem = document.createElement('li');
                listItem.className = `contact-item ${contact.is_favorite ? 'favorite' : ''}`;
                listItem.innerHTML = `
                    <div class="contact-info">
                        <h3>${contact.name}</h3>
                        ${(() => {
                            const groupedDetails = {};
                            contact.contact_details.forEach(detail => {
                                if (!groupedDetails[detail.type]) {
                                    groupedDetails[detail.type] = [];
                                }
                                groupedDetails[detail.type].push(detail.value);
                            });
                            
                            return Object.keys(groupedDetails).map(type => {
                                const values = groupedDetails[type];
                                if (values.length === 0) return '';

                                let htmlContent = `<span class="detail-type-label">${type}:</span>`;

                                if (values.length > 0) {
                                    htmlContent += `<span class="detail-value-first">${values[0]}</span>`;
                                }

                                for (let i = 1; i < values.length; i++) {
                                    htmlContent += `<br><span class="detail-value-subsequent">${values[i]}</span>`;
                                }

                                return `<p class="contact-detail-line">${htmlContent}</p>`;
                            }).join('');
                          })()}
                      </div>
                      <div>
                          <button class="favorite-btn ${contact.is_favorite ? 'is-favorite' : ''}" data-id="${contact.id}">★</button>
                          <button class="edit-contact-btn" data-id="${contact.id}">编辑</button>
                          <button class="delete-contact-btn" data-id="${contact.id}">删除</button>
                      </div>
                  `;
                  contactList.appendChild(listItem);
              });
        }

        function openModal(contact = null) {
            contactModal.style.display = 'flex';
            contactForm.reset(); // 重置表单
            contactDetailsContainer.innerHTML = '<h3>联系方式:</h3>'; // 清空联系方式
            currentEditingContact = contact;

            if (contact) {
                modalTitle.textContent = '编辑联系人';
                contactIdInput.value = contact.id;
                contactNameInput.value = contact.name;
                contact.contact_details.forEach(detail => addDetailInput(detail.type, detail.value));
            } else {
                modalTitle.textContent = '添加新联系人';
                contactIdInput.value = '';
                addDetailInput(); // 默认添加一个空白联系方式
            }
        }

        function closeModal() {
            contactModal.style.display = 'none';
        }

        function addDetailInput(type = '', value = '') {
            const detailDiv = document.createElement('div');
            detailDiv.className = 'contact-detail-item';
            detailDiv.innerHTML = `
                <select class="detail-type">
                    <option value="phone" ${type === 'phone' ? 'selected' : ''}>电话</option>
                    <option value="email" ${type === 'email' ? 'selected' : ''}>邮箱</option>
                    <option value="social_media" ${type === 'social_media' ? 'selected' : ''}>社交媒体</option>
                    <option value="address" ${type === 'address' ? 'selected' : ''}>地址</option>
                    <option value="other" ${type === 'other' ? 'selected' : ''}>其他</option>
                </select>
                <input type="text" class="detail-value" value="${value}" required>
                <button type="button" class="remove-detail-btn">删除</button><br>
            `;
            contactDetailsContainer.appendChild(detailDiv);

            detailDiv.querySelector('.remove-detail-btn').addEventListener('click', (event) => {
                detailDiv.remove();
            });
        }

        addContactBtn.addEventListener('click', () => openModal());
        closeModalBtn.addEventListener('click', closeModal);
        addDetailBtn.addEventListener('click', () => addDetailInput());

        importBtn.addEventListener('click', () => importFileInput.click());

        importFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // 1) 基础校验：扩展名与大小
            const lowerName = (file.name || '').toLowerCase();
            if (!lowerName.endsWith('.xlsx') && !lowerName.endsWith('.xls')) {
                alert('请选择 .xlsx 或 .xls 格式的 Excel 文件');
                event.target.value = '';
                return;
            }
            // 可按需调整大小上限（比如 10MB）
            const maxSizeMB = 10;
            if (file.size > maxSizeMB * 1024 * 1024) {
                alert(`文件过大，请选择小于 ${maxSizeMB}MB 的文件`);
                event.target.value = '';
                return;
            }

            const formData = new FormData();
            // 字段名保持为 file（与后端常见约定一致）
            formData.append('file', file, file.name);

            try {
                const response = await fetch(`${API_BASE_URL}/import_contacts`, {
                    method: 'POST',
                    body: formData,
                });

                // 2) 无论成功失败，先读取响应体，方便定位 500
                const contentType = response.headers.get('content-type') || '';
                const rawText = await response.text();

                if (!response.ok) {
                    console.error('导入失败 HTTP:', response.status);
                    console.error('导入失败响应体:', rawText);

                    // 优先尝试展示 JSON 错误信息
                    let msg = rawText;
                    if (contentType.includes('application/json')) {
                        try {
                            const json = JSON.parse(rawText);
                            msg = json.message || json.error || JSON.stringify(json);
                        } catch (_) {
                            // ignore
                        }
                    }

                    alert(`导入失败（HTTP ${response.status}）\n\n${String(msg).slice(0, 1200)}`);
                    return;
                }

                // 3) 成功：如果返回 JSON 就解析 JSON，否则直接提示
                let okMsg = '联系人导入成功！';
                if (contentType.includes('application/json')) {
                    try {
                        const json = JSON.parse(rawText);
                        okMsg = json.message || okMsg;
                    } catch (_) {}
                }
                alert(okMsg);

                renderContacts(); // 重新渲染列表
            } catch (error) {
                console.error('导入联系人请求异常:', error);
                alert('导入联系人请求异常（网络/跨域/代理问题），请查看控制台');
            } finally {
                event.target.value = ''; // 清空文件输入，以便再次导入相同文件
            }
        });

        exportBtn.addEventListener('click', () => {
            window.location.href = `${API_BASE_URL}/export_contacts`;
        });

        toggleFavoriteBtn.addEventListener('click', () => {
            showFavoritesOnly = !showFavoritesOnly;
            toggleFavoriteBtn.textContent = showFavoritesOnly ? '显示所有' : '显示收藏';
            renderContacts();
        });

        contactForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const contactId = contactIdInput.value;
            const name = contactNameInput.value;
            const contactDetails = [];
            document.querySelectorAll('.contact-detail-item').forEach(item => {
                const type = item.querySelector('.detail-type').value;
                const value = item.querySelector('.detail-value').value;
                if (value) {
                    contactDetails.push({ type, value });
                }
            });

            const contactData = {
                name,
                contact_details: contactDetails
            };

            console.log('Sending contact data:', contactData); // 添加日志

            try {
                let response;
                if (contactId) {
                    const url = `${API_BASE_URL}/contacts/${contactId}`;
                    console.log('Updating contact at URL:', url); // 添加日志
                    response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(contactData),
                    });
                } else {
                    const url = `${API_BASE_URL}/contacts`;
                    console.log('Creating contact at URL:', url); // 添加日志
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(contactData),
                    });
                }

                if (!response.ok) {
                    throw new Error('保存联系人失败');
                }
                closeModal();
                renderContacts(); // 重新渲染列表
            } catch (error) {
                console.error('保存联系人失败:', error);
                alert('保存联系人失败！');
            }
        });

        contactList.addEventListener('click', async (event) => {
            if (event.target.classList.contains('favorite-btn')) {
                const contactId = parseInt(event.target.dataset.id);
                const contactItem = event.target.closest('.contact-item');
                const currentFavoriteStatus = contactItem.classList.contains('favorite');
                updateFavoriteStatus(contactId, !currentFavoriteStatus); // 调用后端 API 更新状态
            } else if (event.target.classList.contains('edit-contact-btn')) {
                const contactId = parseInt(event.target.dataset.id);
                fetch(`${API_BASE_URL}/contacts`)
                    .then(response => response.json())
                    .then(contactsData => {
                        const contactToEdit = contactsData.find(c => c.id === contactId);
                        if (contactToEdit) {
                            openModal(contactToEdit);
                        }
                    })
                    .catch(error => console.error('获取联系人详情失败:', error));
            } else if (event.target.classList.contains('delete-contact-btn')) {
                const contactId = parseInt(event.target.dataset.id);
                if (confirm('确定要删除此联系人吗？')) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/contacts/${contactId}`, {
                            method: 'DELETE',
                        });
                        if (!response.ok) {
                            throw new Error('删除联系人失败');
                        }
                        console.log('联系人删除成功');
                        renderContacts(); // 重新渲染列表
                    } catch (error) {
                        console.error('删除联系人失败:', error);
                        alert('删除联系人失败！');
                    }
                }
            }
        });

        renderContacts(); // 初始化渲染
    </script>
</body>
</html>
